name: Sigstore Compatibility Matrix Test

on:
  workflow_dispatch:
    inputs:
      v2_repository:
        description: 'v2 Repository (owner/repo)'
        required: true
        default: 'open-component-model/ocm'
        type: string
      v2_ref:
        description: 'v2 Reference (tag/branch/commit)'
        required: true
        default: 'v0.34.1'
        type: string
      
      v3_repository:
        description: 'v3 Repository (owner/repo)'
        required: true
        default: 'morri-son/ocm'
        type: string
      v3_ref:
        description: 'v3 Reference (tag/branch/commit)'
        required: true
        default: 'test/sigstore-v3-compatibility'
        type: string

jobs:
  compatibility-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # v2 sign, v2 verify
          - signing_repo: ${{ inputs.v2_repository }}
            signing_ref: ${{ inputs.v2_ref }}
            verifying_repo: ${{ inputs.v2_repository }}
            verifying_ref: ${{ inputs.v2_ref }}
            test_name: "v2_signs_v2_verifies"
          
          # v2 sign, v3 verify
          - signing_repo: ${{ inputs.v2_repository }}
            signing_ref: ${{ inputs.v2_ref }}
            verifying_repo: ${{ inputs.v3_repository }}
            verifying_ref: ${{ inputs.v3_ref }}
            test_name: "v2_signs_v3_verifies"
          
          # v3 sign, v2 verify
          - signing_repo: ${{ inputs.v3_repository }}
            signing_ref: ${{ inputs.v3_ref }}
            verifying_repo: ${{ inputs.v2_repository }}
            verifying_ref: ${{ inputs.v2_ref }}
            test_name: "v3_signs_v2_verifies"
          
          # v3 sign, v3 verify
          - signing_repo: ${{ inputs.v3_repository }}
            signing_ref: ${{ inputs.v3_ref }}
            verifying_repo: ${{ inputs.v3_repository }}
            verifying_ref: ${{ inputs.v3_ref }}
            test_name: "v3_signs_v3_verifies"
      
      fail-fast: false
    
    name: ${{ matrix.test_name }}
    
    steps:
      - name: Setup Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: '1.25.4'
      
      - name: Checkout CLI for Signing
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.signing_repo }}
          ref: ${{ matrix.signing_ref }}
          path: ocm-signing
          fetch-depth: 1
      
      - name: Build Signing CLI
        run: |
          echo "Building OCM CLI for signing"
          echo "  Repository: ${{ matrix.signing_repo }}"
          echo "  Reference:  ${{ matrix.signing_ref }}"
          cd ocm-signing
          make install
          mv ~/go/bin/ocm /tmp/ocm-signing-cli
          /tmp/ocm-signing-cli version
      
      - name: Checkout CLI for Verify
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.verifying_repo }}
          ref: ${{ matrix.verifying_ref }}
          path: ocm-verifying
          fetch-depth: 1
      
      - name: Build Verifying CLI
        run: |
          echo "Building OCM CLI for verifying"
          echo "  Repository: ${{ matrix.verifying_repo }}"
          echo "  Reference:  ${{ matrix.verifying_ref }}"
          cd ocm-verifying
          make install
          mv ~/go/bin/ocm /tmp/ocm-verifying-cli
          /tmp/ocm-verifying-cli version
      
      - name: Create Test Component
        run: |
          # Create component.yaml using component-constructor
          cat > /tmp/component.yaml << 'EOF'
          components:
          - name: ocm.software/test-comp
            version: 1.0.0
            provider:
              name: ocm.software
            resources:
              - name: podinfo-image
                version: 1.0.0
                type: ociImage
                access:
                  type: ociArtifact
                  imageReference: ghcr.io/stefanprodan/charts/podinfo:6.7.1
          EOF
          
          # Create component version using component-constructor
          /tmp/ocm-signing-cli add cv --create --file /tmp/ctf /tmp/component.yaml
      
      - name: Sign Component
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          echo "Signing component..."
          /tmp/ocm-signing-cli sign cv \
            --signature test-sig-${{ matrix.test_name }} \
            --algorithm sigstore \
            --keyless \
            /tmp/ctf//ocm.software/test-comp:1.0.0
          
          echo "Signature created successfully"
      
      - name: Verify Component
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          echo "Verifying component..."
          /tmp/ocm-verifying-cli verify cv \
            --signature test-sig-${{ matrix.test_name }} \
            --keyless \
            /tmp/ctf//ocm.software/test-comp:1.0.0
          
          echo "Verification successful"
      
      - name: Display Component Info
        if: always()
        run: |
          echo "=== Component Details ==="
          /tmp/ocm-verifying-cli get cv /tmp/ctf//ocm.software/test-comp:1.0.0 -oyaml | head -50
      
      - name: Test Result Summary
        if: success()
        run: |
          echo "✅ SUCCESS: ${{ matrix.test_name }}"
          echo ""
          echo "Signing:"
          echo "  Repository: ${{ matrix.signing_repo }}"
          echo "  Reference:  ${{ matrix.signing_ref }}"
          echo ""
          echo "Verifying:"
          echo "  Repository: ${{ matrix.verifying_repo }}"
          echo "  Reference:  ${{ matrix.verifying_ref }}"
      
      - name: Upload Test Artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: failed-${{ matrix.test_name }}
          path: |
            /tmp/ctf/
            /tmp/component.yaml
            /tmp/*.log
          retention-days: 7

  summary:
    needs: compatibility-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Test Summary
        run: |
          echo "# Sigstore Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **v2**: \`${{ inputs.v2_repository }}@${{ inputs.v2_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **v3**: \`${{ inputs.v3_repository }}@${{ inputs.v3_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Signing | Verifying | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| v2 | v2 | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| v2 | v3 | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| v3 | v2 | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| v3 | v3 | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
